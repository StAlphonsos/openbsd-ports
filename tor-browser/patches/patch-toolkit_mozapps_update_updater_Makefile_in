$OpenBSD$

diff -Nup mozilla-esr31/toolkit/mozapps/update/updater/Makefile.in tor-browser/toolkit/mozapps/update/updater/Makefile.in
--- toolkit/mozapps/update/updater/Makefile.in.orig	Mon Jan  5 23:08:06 2015
+++ toolkit/mozapps/update/updater/Makefile.in	Tue Feb 17 14:37:56 2015
@@ -3,6 +3,9 @@
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
+# Use NSS for MAR signature verification on all platforms:
+MAR_NSS=1
+
 # Don't link the updater against libmozglue. See bug 687139
 MOZ_GLUE_LDFLAGS =
 MOZ_GLUE_PROGRAM_LDFLAGS =
@@ -18,11 +21,23 @@ LIBS += \
   $(MOZ_BZ2_LIBS) \
   $(NULL)
 
-ifeq ($(OS_ARCH),WINNT)
+LIBS += $(call EXPAND_LIBNAME_PATH,signmar,$(DEPTH)/modules/libmar/sign)
 LIBS += $(call EXPAND_LIBNAME_PATH,verifymar,$(DEPTH)/modules/libmar/verify)
+ifeq ($(OS_ARCH),WINNT)
 OS_LIBS += $(call EXPAND_LIBNAME,comctl32 ws2_32 shell32 shlwapi)
+ifdef MAR_NSS
+LINK_UPDATER_WITH_NSS=1
 endif
+else
+LINK_UPDATER_WITH_NSS=1
+endif
 
+ifdef LINK_UPDATER_WITH_NSS
+LIBS += $(DIST)/lib/$(LIB_PREFIX)nss3.$(LIB_SUFFIX) \
+	$(DIST)/lib/$(LIB_PREFIX)nssutil3.$(LIB_SUFFIX) \
+	$(NSPR_LIBS)
+endif
+
 ifdef MOZ_WIDGET_GTK
 OS_CXXFLAGS += $(TK_CFLAGS)
 OS_LIBS += $(TK_LIBS)
@@ -44,6 +59,21 @@ endif
 
 include $(topsrcdir)/config/rules.mk
 
+ifneq (,$(filter alpha beta release esr,$(MOZ_UPDATE_CHANNEL)))
+	PRIMARY_CERT = release_primary.der
+	SECONDARY_CERT = release_secondary.der
+else ifneq (,$(filter nightly aurora nightly-elm nightly-profiling nightly-oak nightly-ux,$(MOZ_UPDATE_CHANNEL)))
+	PRIMARY_CERT = nightly_aurora_level3_primary.der
+	SECONDARY_CERT = nightly_aurora_level3_secondary.der
+else
+	PRIMARY_CERT = xpcshellCertificate.der
+	SECONDARY_CERT = xpcshellCertificate.der
+endif
+
+export::
+	$(PYTHON) $(srcdir)/gen_cert_header.py primaryCertData $(srcdir)/$(PRIMARY_CERT) > primaryCert.h
+	$(PYTHON) $(srcdir)/gen_cert_header.py secondaryCertData $(srcdir)/$(SECONDARY_CERT) > secondaryCert.h
+
 ifdef MOZ_WIDGET_GTK
 libs:: updater.png
 	$(NSINSTALL) -D $(DIST)/bin/icons
@@ -61,9 +91,11 @@ libs::
 	rm -f $(DIST)/bin/updater
 endif
 
+ifndef LINK_UPDATER_WITH_NSS
 ifeq ($(OS_ARCH),WINNT)
 EXTRA_LIBS += $(call EXPAND_LIBNAME,crypt32)
 EXTRA_LIBS += $(call EXPAND_LIBNAME,advapi32)
+endif
 endif
 
 CXXFLAGS += $(MOZ_BZ2_CFLAGS)
