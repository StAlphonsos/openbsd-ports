$OpenBSD$

diff -Nup mozilla-esr31/python/mozbuild/mozbuild/base.py tor-browser/python/mozbuild/mozbuild/base.py
--- python/mozbuild/mozbuild/base.py.orig	Mon Jan  5 23:07:59 2015
+++ python/mozbuild/mozbuild/base.py	Tue Feb 17 14:37:56 2015
@@ -161,8 +161,7 @@ class MozbuildObject(ProcessExecutionMixin):
         # environment. If no mozconfig is present, the config will not have
         # much defined.
         loader = MozconfigLoader(topsrcdir)
-        current_project = os.environ.get('MOZ_CURRENT_PROJECT')
-        config = loader.read_mozconfig(mozconfig, moz_build_app=current_project)
+        config = loader.read_mozconfig(mozconfig)
 
         config_topobjdir = MozbuildObject.resolve_mozconfig_topobjdir(
             topsrcdir, config)
@@ -172,30 +171,13 @@ class MozbuildObject(ProcessExecutionMixin):
         # inside an objdir you probably want to perform actions on that objdir,
         # not another one. This prevents accidental usage of the wrong objdir
         # when the current objdir is ambiguous.
-        # However, if the found mozconfig resolves to another objdir that
-        # doesn't exist, we may be in a subtree like when building mozilla/
-        # under c-c, and the objdir was defined as a relative path. Try again
-        # adjusting for that.
-
         if topobjdir and config_topobjdir:
-            if not os.path.exists(config_topobjdir):
-                config_topobjdir = MozbuildObject.resolve_mozconfig_topobjdir(
-                    os.path.dirname(topsrcdir), config)
-                if current_project:
-                    config_topobjdir = os.path.join(config_topobjdir,
-                        current_project)
-                config_topobjdir = os.path.join(config_topobjdir,
-                    os.path.basename(topsrcdir))
-            elif current_project:
-                config_topobjdir = os.path.join(config_topobjdir, current_project)
-
-            _config_topobjdir = config_topobjdir
-            mozilla_dir = os.path.join(_config_topobjdir, 'mozilla')
-            if not samepath(topobjdir, _config_topobjdir) \
-                and (not os.path.exists(mozilla_dir) or not samepath(topobjdir,
+            mozilla_dir = os.path.join(config_topobjdir, 'mozilla')
+            if not samepath(topobjdir, config_topobjdir) \
+                and (os.path.exists(mozilla_dir) and not samepath(topobjdir,
                 mozilla_dir)):
 
-                raise ObjdirMismatchException(topobjdir, _config_topobjdir)
+                raise ObjdirMismatchException(topobjdir, config_topobjdir)
 
         topobjdir = topobjdir or config_topobjdir
         if topobjdir:
@@ -251,8 +233,7 @@ class MozbuildObject(ProcessExecutionMixin):
         """
         if self._mozconfig is None:
             loader = MozconfigLoader(self.topsrcdir)
-            self._mozconfig = loader.read_mozconfig(
-                moz_build_app=os.environ.get('MOZ_CURRENT_PROJECT'))
+            self._mozconfig = loader.read_mozconfig()
 
         return self._mozconfig
 
@@ -567,13 +548,8 @@ class MachCommandBase(MozbuildObject):
         # more reliable than mozconfig when cwd is inside an objdir.
         topsrcdir = context.topdir
         topobjdir = None
-        detect_virtualenv_mozinfo = True
-        if hasattr(context, 'detect_virtualenv_mozinfo'):
-            detect_virtualenv_mozinfo = getattr(context,
-                'detect_virtualenv_mozinfo')
         try:
-            dummy = MozbuildObject.from_environment(cwd=context.cwd,
-                detect_virtualenv_mozinfo=detect_virtualenv_mozinfo)
+            dummy = MozbuildObject.from_environment(cwd=context.cwd)
             topsrcdir = dummy.topsrcdir
             topobjdir = dummy._topobjdir
         except BuildEnvironmentNotFoundException:
